name: Ready to Merge Workflow
on:
  workflow_call:
    inputs:
      labels:
        description: The GitHub event's labels
        required: true
        type: string
      is-pr:
        description: Whether the workflow is running on a PR
        required: true
        type: boolean

jobs:
  ready-to-merge-gate:
    name: 'Missing "ready-to-merge" label'
    runs-on: ubuntu-latest
    steps:
      - name: Check for exact 'ready-to-merge' label
        if: ${{ inputs.is-pr }}
        id: check-label
        run: |
          # Use jq to check for exact label match (avoids substring matching issues with contains())
          if echo '${{ inputs.labels }}' | jq -e '.[] | select(.name == "ready-to-merge")' > /dev/null; then
            echo "label_found=true" >> $GITHUB_OUTPUT
          else
            echo "label_found=false" >> $GITHUB_OUTPUT
          fi
      # Since Github also accepts `skipped` results for Required Workflows, we need
      # to fail the job to ensure that the downstream jobs don't just skip.
      - name: Fail until the 'ready-to-merge' label is present
        if: ${{ inputs.is-pr && steps.check-label.outputs.label_found == 'false' }}
        run: |
          echo "Add the 'ready-to-merge' label to run CI."
          exit 1
      - name: Gate passed
        if: ${{ inputs.is-pr && steps.check-label.outputs.label_found == 'true' }}
        run: echo "Label present. Proceeding with CI."
      - name: Gate passed
        if: ${{ !inputs.is-pr }}
        run: echo "Not a PR. Proceeding with CI."
